@{
    ViewData["Title"] = "Список товаров";
}

<h2>Список</h2>

<div>
    <h4>Товаров</h4>
</div>

<table class="table">
    <thead>
        <tr>
            <th>
                Название
            </th>
            <th>
                Цена
            </th>
            <th />
        </tr>
    </thead>

    <tbody id="list" />
</table>

<div>
    <a asp-action="Create">Добавить</a>
</div>

<script>
    function getContext(controller, action) {
            return fetch("/" + controller + "/" + action);
        }

    function postContext(controller, action, body) {
        return fetch("/" + controller + "/" + action, {
            method: "Post",
            headers: {
                "Content-Type": "application/json"
            },
            body: body
        });
    }

    function ready(callback) {
        if (document.readyState != "loading") callback();
        else document.addEventListener("DOMContentLoaded", callback);
    }
    ready(getProducts);

    function getProducts() {
        getContext("Product", "GetProducts")
            .then(response => response.json())
            .then(function (commits) {
                if (commits != 0 && commits != null) {
                    commits.forEach(element => unpackingProducts(element));
                }
                else {
                    unpackingProducts();
               }
            });
    }

    function unpackingProducts(element) {
        if (element == undefined) {
            element = { id: "Null", name: "Null", price: "Null" };
        }
        var tr = document.createElement("tr");

        var th = document.createElement("th");
        th.textContent = element.name;
        tr.appendChild(th);

        th = document.createElement("th");
        th.textContent = element.price;
        tr.appendChild(th);

        th = document.createElement("th");

        if (element.id != "Null") {
            var a = document.createElement("a");
            a.href = "#";
            a.setAttribute("onclick", "Edit(" + element.id + ")");
            a.textContent = "Изменить";
            th.appendChild(a);

            th.appendChild(document.createTextNode(" | "));

            a = document.createElement("a");
            a.href = "#";
            a.setAttribute("onclick", "Delete(" + element.id + ", '" + element.name + "')");
            a.textContent = "Удалить";
            th.appendChild(a);
        }
        tr.appendChild(th);

        list.appendChild(tr);
    }

    function Edit(itemId) {
        window.location.href = "/product/edit?id=" + itemId;
    }

    function Delete(itemId, name) {
        var isDelete = confirm("Удалить товар " + name + "?");
        if (isDelete) {
            postContext("Product", "Delete", JSON.stringify({
                Id: itemId
            }))
                .then(response => response.json())
                .then(function (commit) {
                    if (commit == "Success") {
                        alert("Удалено!");
                        window.location.href = "/product";
                    }
                    else {
                        alert(commit);
                    }
                });
        }
    }
</script>