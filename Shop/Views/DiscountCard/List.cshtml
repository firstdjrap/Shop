@{
    ViewData["Title"] = "Список дисконтных карт";
}

<h2>Список</h2>

<div>
    <h4>Дисконтных карт</h4>
</div>

<table class="table">
    <thead>
        <tr>
            <th>
                Номер
            </th>
            <th>
                Проценты
            </th>
            <th>
                Срок действия
            </th>
            <th />
        </tr>
    </thead>

    <tbody id="list" />
</table>

<div>
    <a asp-action="Create">Добавить</a>
</div>

<script>
    function convertMonthToDate(month, createdAt) {
        dateCreate = createdAt.split('-');

        var yearD = Math.floor(month / 12);
        var year = parseInt(dateCreate[0]) + yearD;

        month = parseInt(dateCreate[1]) + month - yearD * 12;

        if (month > 12) {
            year++;

            month = month - 12;
        }

        return month + "/" + year;
    }

    function ready(callback) {
        if (document.readyState != "loading") callback();
        else document.addEventListener("DOMContentLoaded", callback);
    }
    ready(getDiscountCards);

    function getDiscountCards() {
        getContext("DiscountCard", "GetDiscountCards")
            .then(response => response.json())
            .then(function (commits) {
                if (commits != 0 && commits != null) {
                    commits.forEach(element => unpackingDiscountCards(element));
                }
                else {
                    unpackingDiscountCards();
                }
            });
    }

    function unpackingDiscountCards(element) {
        if (element == undefined) {
            element = { number: "Null", percent: "Null", lifeTime: "Null" };
        }
        var tr = document.createElement("tr");

        var th = document.createElement("th");
        th.textContent = element.number;
        tr.appendChild(th);

        th = document.createElement("th");
        th.textContent = element.percent;
        tr.appendChild(th);

        th = document.createElement("th");
        th.textContent = convertMonthToDate(element.lifeTime, element.createdAt);
        tr.appendChild(th);

        th = document.createElement("th");
        
        if (element.id != "Null") {
            var a = document.createElement("a");
            a.href = "#";
            a.setAttribute("onclick", "Edit(" + element.id + ")");
            a.textContent = "Изменить";
            th.appendChild(a);

            th.appendChild(document.createTextNode(" | "));

            a = document.createElement("a");
            a.href = "#";
            a.setAttribute("onclick", "Delete(" + element.id + ", '" + element.number + "')");
            a.textContent = "Удалить";
            th.appendChild(a);
        }
        tr.appendChild(th);

        list.appendChild(tr);
    }

    function Edit(itemId) {
        window.location.href = "/discountcard/edit?id=" + itemId;
    }

    function Delete(itemId, name) {
        var isDelete = confirm("Удалить карту " + name + "?");
        if (isDelete) {
            postContext("DiscountCard", "Delete", JSON.stringify(itemId))
                .then(response => response.json())
                .then(function (commit) {
                    if (commit == "Success") {
                        alert("Удалено!");
                        window.location.href = "/discountcard/list";
                    }
                    else {
                        alert(commit);
                    }
                });
        }
    }
</script>